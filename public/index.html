<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestion des Places - Demandes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body id="body-index">
    <nav>
        <div class="navigation">
                <a href="/" class="nav-link active">Demandes</a>
                <a href="/salle" class="nav-link">Salle</a>
        </div>
    </nav>
    <div class="container">

        <div class="main-content">
            <!-- Section pour g√©rer les demandes -->
            <div class="section management-section">
                <h2 class="section-title">Demandes en cours</h2>
                <p id="available-places-resume"><span id="totalAvailable">1509</span> places disponibles</p>
                
                <div class="filters">
                    <select id="statusFilter" onchange="filterRequests()">
                        <option value="all">Tous les statuts</option>
                        <option value="pending">En attente</option>
                        <option value="in-progress">En cours</option>
                        <option value="available">Attribu√©</option>
                        <option value="available-separated">Attribu√© (s√©par√©)</option>
                    </select>
                </div>
                
                <div class="requests-list" id="requestsList">
                    <div class="empty-state">
                        <p>üì≠ Aucune demande en cours...</p>
                        <p>Les nouvelles demandes appara√Ætront ici automatiquement</p>
                    </div>
                </div>
            </div>
            
            <!-- Section pour faire une demande de place -->
            <div class="section request-section">

                <form id="requestForm" class="request-form">
                    <div class="form-group">
                        <label for="userName">Votre nom</label>
                        <input type="text" id="userName" required placeholder="Entrez votre nom">
                    </div>

                    <div class="form-group">
                        <label for="placesNeeded">Nombre de places n√©cessaires</label>
                        <input type="number" id="placesNeeded" min="1" max="20" required placeholder="Ex: 4">
                    </div>

                    <div class="form-group">
                        <label for="comment">Commentaire (optionnel)</label>
                        <textarea id="comment" placeholder="Informations suppl√©mentaires..." rows="2"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        + Cr√©er la demande
                    </button>
                </form>
            </div>

        </div>
    </div>

    <!-- Modale pour traiter une demande -->
    <div class="modal-overlay" id="zoneModalOverlay" onclick="closeZoneModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">üéØ Traiter la demande</h3>
                <button class="btn-close" onclick="closeZoneModal()">‚úñ</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="handlerName">Votre nom *</label>
                    <input type="text" id="handlerName" required placeholder="Qui traite cette demande ?">
                </div>
                
                <!-- Choix du type de traitement (visible lors de la prise en charge) -->
                <div id="treatmentChoice" style="display: none;">
                    <p><strong>Comment traiter cette demande ?</strong></p>
                    <div class="treatment-selection">
                        <div class="treatment-option">
                            <input type="radio" name="selectedTreatment" value="available" 
                                   id="treatment-normal" onchange="onTreatmentSelected()">
                            <label for="treatment-normal">
                                <strong>‚úÖ Places normales (ensemble)</strong>
                                <small>Les personnes seront assises c√¥te √† c√¥te</small>
                            </label>
                        </div>
                        <div class="treatment-option">
                            <input type="radio" name="selectedTreatment" value="available-separated" 
                                   id="treatment-separated" onchange="onTreatmentSelected()">
                            <label for="treatment-separated">
                                <strong>‚ö†Ô∏è Places s√©par√©es (pas c√¥te √† c√¥te)</strong>
                                <small>Les personnes ne seront pas assises ensemble</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- S√©lection de zone (visible apr√®s choix du traitement) -->
                <div id="zoneChoice" style="display: none;">
                    <p>S√©lectionnez la zone pour cette demande :</p>
                    <div class="zone-selection" id="zoneSelection">
                        <!-- Les zones disponibles seront ajout√©es dynamiquement -->
                    </div>
                </div>
                
                <div class="modal-info">
                    <strong>Demande :</strong> <span id="modalRequestInfo"></span>
                </div>
                
                <div class="status-info" id="statusInfo">
                    <!-- Informations sur le type d'attribution -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="goBackToTreatmentChoice()" id="backBtn" style="display: none;">
                    ‚Üê Retour
                </button>
                <button class="btn btn-success" onclick="confirmZoneAssignment()" id="confirmZoneBtn" disabled>
                    ‚úÖ Confirmer
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * üéØ APPLICATION DE GESTION DES DEMANDES
         * Version optimis√©e mobile sans notifications
         */

        // ===========================================
        // CONFIGURATION ET VARIABLES GLOBALES
        // ===========================================

        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5,
            timeout: 20000
        });

        let currentRequests = new Map();
        let zones = {};
        let connectedUsers = 0;
        let currentRequestForZone = null;

        // ===========================================
        // FEEDBACK TACTILE (pour mobile)
        // ===========================================
        
        function vibrate(pattern = [50]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // ===========================================
        // GESTION DES CONNEXIONS SOCKET.IO
        // ===========================================

        socket.on('connect', () => {
            console.log('‚úÖ Connect√© au serveur');
            updateConnectionStatus(true);
            vibrate([100]); // Vibration de connexion
        });

        socket.on('disconnect', (reason) => {
            console.log('‚ùå D√©connexion:', reason);
            updateConnectionStatus(false);
        });

        socket.on('reconnect', () => {
            console.log('üîÑ Reconnexion r√©ussie');
            updateConnectionStatus(true);
            vibrate([50, 50, 100]); // Vibration de reconnexion
        });

        // R√©ception des donn√©es initiales
        socket.on('initial_data', (data) => {
            console.log('üì• Donn√©es initiales re√ßues', data);
            
            currentRequests.clear();
            data.requests.forEach(request => {
                currentRequests.set(request.id, request);
            });
            
            zones = data.zones;
            
            updateRequestsList();
            updateZonesSummary();
            updateConnectedUsers(data.connectedUsers);
        });

        // Gestion des √©v√©nements de demandes
        socket.on('new_request', (request) => {
            console.log('üì® Nouvelle demande:', request);
            currentRequests.set(request.id, request);
            addRequestToList(request);
            vibrate([100, 50, 100]); // Vibration pour nouvelle demande
        });

        socket.on('request_updated', (request) => {
            console.log('üîÑ Demande mise √† jour:', request);
            currentRequests.set(request.id, request);
            updateRequestInList(request);
            vibrate([50]); // Vibration l√©g√®re pour mise √† jour
        });

        socket.on('request_abandoned', (data) => {
            console.log('‚ùå Demande abandonn√©e:', data);
            const request = currentRequests.get(data.requestId);
            if (request) {
                request.status = 'pending';
                request.handledBy = null;
                request.handledByName = null;
                currentRequests.set(data.requestId, request);
                updateRequestInList(request);
            }
            
            // Fermer la modale si c'est celle qui √©tait ouverte
            if (currentRequestForZone && currentRequestForZone.requestId === data.requestId) {
                document.getElementById('zoneModalOverlay').style.display = 'none';
                currentRequestForZone = null;
                document.getElementById('confirmZoneBtn').disabled = true;
            }
        });

        socket.on('request_deleted', (data) => {
            currentRequests.delete(data.requestId);
            const element = document.querySelector(`[data-request-id="${data.requestId}"]`);
            if (element) element.remove();
        });

        // Gestion des mises √† jour de zones
        socket.on('zone_updated', (data) => {
            if (zones[data.zoneId]) {
                zones[data.zoneId].current = data.current;
                updateZonesSummary();
            }
        });

        socket.on('zone_updated_from_request', (data) => {
            if (zones[data.zoneId]) {
                zones[data.zoneId].current = data.current;
                updateZonesSummary();
                vibrate([100, 100, 100]); // Vibration pour attribution r√©ussie
            }
        });

        socket.on('users_count', (count) => {
            updateConnectedUsers(count);
        });

        socket.on('error', (error) => {
            console.error('‚ùå Erreur serveur:', error);
            vibrate([200, 100, 200]); // Vibration d'erreur
        });

        // ===========================================
        // GESTION DU FORMULAIRE DE DEMANDE
        // ===========================================

        document.getElementById('requestForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                userName: document.getElementById('userName').value.trim(),
                placesNeeded: parseInt(document.getElementById('placesNeeded').value),
                comment: document.getElementById('comment').value.trim()
            };
            
            // Validation
            if (!formData.userName || !formData.placesNeeded) {
                vibrate([200, 100, 200]); // Vibration d'erreur
                return;
            }
            
            if (formData.placesNeeded < 1 || formData.placesNeeded > 20) {
                vibrate([200, 100, 200]); // Vibration d'erreur
                return;
            }
            
            console.log('üì§ Envoi de la demande:', formData);
            socket.emit('create_request', formData);
            
            // Reset du formulaire
            e.target.reset();
            vibrate([100]); // Vibration de succ√®s
        });

        // ===========================================
        // GESTION DES DEMANDES
        // ===========================================

        function updateRequestsList() {
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';
            
            if (currentRequests.size === 0) {
                requestsList.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Aucune demande en cours...</p>
                        <p>Les nouvelles demandes appara√Ætront ici automatiquement</p>
                    </div>
                `;
                return;
            }
            
            const sortedRequests = Array.from(currentRequests.values())
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedRequests.forEach(request => {
                addRequestToList(request);
            });
        }

        function addRequestToList(request) {
            const requestsList = document.getElementById('requestsList');
            const emptyState = requestsList.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            const requestElement = createRequestElement(request);
            requestsList.appendChild(requestElement);
        }

        function updateRequestInList(request) {
            const existing = document.querySelector(`[data-request-id="${request.id}"]`);
            if (existing) {
                const newElement = createRequestElement(request);
                existing.parentNode.replaceChild(newElement, existing);
            } else {
                addRequestToList(request);
            }
        }

        function createRequestElement(request) {
            const div = document.createElement('div');
            div.className = `request-card ${request.status}`;
            div.setAttribute('data-request-id', request.id);
            
            const date = new Date(request.timestamp);
            const formattedTime = date.toLocaleString('fr-FR', {
                hour: "2-digit",
                minute: "2-digit"
            });
            
            const statusTexts = {
                'pending': 'En attente',
                'in-progress': 'En cours de traitement',
                'available': 'Places attribu√©es',
                'not-available': 'Non disponible',
                'available-separated': 'Places attribu√©es (s√©par√©es)'
            };

            div.innerHTML = `
                <div class="request-header">
                    <div class="request-places">
                        <span class="places-count">${request.placesNeeded}</span>
                        <span class="places-label">place(s)</span>
                    </div>
                    <div class="status-badge status-${request.status}">
                        ${statusTexts[request.status]}
                    </div>
                </div>

                <div class="request-body">
                    <div class="request-info">
                        <div class="info-item">
                            <span class="icon">üë§</span>
                            <strong>${request.userName}</strong>
                        </div>
                        <div class="info-item">
                            <span class="icon">üïê</span>
                            ${formattedTime}
                        </div>
                        ${request.comment ? `
                            <div class="info-item">
                                <span class="icon">üí¨</span>
                                ${request.comment}
                            </div>
                        ` : ''}
                        ${request.assignedZone ? `
                            <div class="info-item">
                                <span class="icon">üìç</span>
                                Zone: ${zones[request.assignedZone]?.name || request.assignedZone}
                            </div>
                        ` : ''}
                        ${request.handledByName ? `
                            <div class="info-item">
                                <span class="icon">‚úã</span>
                                Trait√© par: ${request.handledByName}
                            </div>
                        ` : ''}
                    </div>

                    ${request.status === 'pending' ? `
                        <div class="request-actions">
                            <button class="btn btn-warning" onclick="takeInCharge('${request.id}')">
                                Prendre en charge
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return div;
        }

        // ===========================================
        // ACTIONS SUR LES DEMANDES
        // ===========================================

        function takeInCharge(requestId) {
            console.log('‚è≥ Prise en charge de la demande:', requestId);
            vibrate([100]); // Feedback tactile
            
            socket.emit('update_request_status', {
                requestId: requestId,
                status: 'in-progress'
            });
            
            setTimeout(() => {
                openZoneModal(requestId, 'process-request');
            }, 100);
        }

        function abandonRequest(requestId) {
            console.log('‚ùå Abandon du traitement de la demande:', requestId);
            vibrate([100, 50, 100]); // Feedback d'abandon
            
            socket.emit('abandon_request', {
                requestId: requestId
            });
        }

        function updateRequestStatus(requestId, status) {
            console.log('üîÑ Mise √† jour statut:', requestId, status);
            socket.emit('update_request_status', {
                requestId: requestId,
                status: status
            });
        }

        // ===========================================
        // GESTION DE LA MODALE DE TRAITEMENT
        // ===========================================

        let currentModalStep = 'treatment'; // 'treatment' ou 'zone'

        function openZoneModal(requestId, action) {
            const request = currentRequests.get(requestId);
            if (!request) return;
            
            currentRequestForZone = { requestId, action };
            currentModalStep = 'treatment'; // Reset √† la premi√®re √©tape
            
            document.getElementById('modalRequestInfo').textContent = 
                `${request.userName} - ${request.placesNeeded} place(s)`;
            
            // Reset des √©l√©ments de la modale
            document.getElementById('handlerName').value = '';
            document.getElementById('treatmentChoice').style.display = 'none';
            document.getElementById('zoneChoice').style.display = 'none';
            document.getElementById('statusInfo').innerHTML = '';
            document.getElementById('confirmZoneBtn').disabled = true;
            document.getElementById('backBtn').style.display = 'none';
            
            // Reset des s√©lections
            const treatmentRadios = document.querySelectorAll('input[name="selectedTreatment"]');
            treatmentRadios.forEach(radio => radio.checked = false);
            
            if (action === 'process-request') {
                document.getElementById('modalTitle').textContent = 'üéØ Traiter la demande';
                document.getElementById('treatmentChoice').style.display = 'block';
                document.getElementById('confirmZoneBtn').textContent = '‚û°Ô∏è Continuer';
                currentModalStep = 'treatment';
                // Le nom est obligatoire pour passer √† l'√©tape suivante
                updateConfirmButtonState();
            } else {
                document.getElementById('modalTitle').textContent = 'üéØ Attribuer des places';
                currentRequestForZone.targetStatus = action;
                showZoneSelection(request, action);
                document.getElementById('confirmZoneBtn').textContent = '‚úÖ Confirmer l\'attribution';
                currentModalStep = 'zone';
            }
            
            document.getElementById('zoneModalOverlay').style.display = 'flex';
            vibrate([50]); // Feedback d'ouverture
        }

        function onTreatmentSelected() {
            console.log('üîò Traitement s√©lectionn√©');
            updateConfirmButtonState();
        }

        function updateConfirmButtonState() {
            const handlerName = document.getElementById('handlerName').value.trim();
            const selectedTreatment = document.querySelector('input[name="selectedTreatment"]:checked');
            const selectedZone = document.querySelector('input[name="selectedZone"]:checked');
            
            console.log('üîÑ Mise √† jour √©tat bouton:', {
                step: currentModalStep,
                handlerName: !!handlerName,
                selectedTreatment: !!selectedTreatment,
                selectedZone: !!selectedZone
            });
            
            if (currentRequestForZone?.action === 'process-request') {
                if (currentModalStep === 'treatment') {
                    // Premi√®re √©tape : nom + traitement obligatoires
                    document.getElementById('confirmZoneBtn').disabled = !(handlerName && selectedTreatment);
                } else {
                    // Deuxi√®me √©tape : zone obligatoire (nom d√©j√† valid√©)
                    document.getElementById('confirmZoneBtn').disabled = !selectedZone;
                }
            } else {
                // Mode attribution directe : nom ET zone
                document.getElementById('confirmZoneBtn').disabled = !(handlerName && selectedZone);
            }
        }

        function goBackToTreatmentChoice() {
            if (!currentRequestForZone) return;
            
            console.log('‚¨ÖÔ∏è Retour √† la premi√®re √©tape');
            
            // Revenir √† la premi√®re √©tape
            currentModalStep = 'treatment';
            document.getElementById('treatmentChoice').style.display = 'block';
            document.getElementById('zoneChoice').style.display = 'none';
            document.getElementById('statusInfo').innerHTML = '';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('confirmZoneBtn').textContent = '‚û°Ô∏è Continuer';
            document.getElementById('modalTitle').textContent = 'üéØ Traiter la demande';
            
            // Reset de la s√©lection de zone
            const zoneRadios = document.querySelectorAll('input[name="selectedZone"]');
            zoneRadios.forEach(radio => radio.checked = false);
            
            updateConfirmButtonState();
            vibrate([30]); // Feedback de retour
        }

        function selectTreatment(treatmentType) {
            const request = currentRequests.get(currentRequestForZone.requestId);
            if (!request) return;
            
            currentRequestForZone.targetStatus = treatmentType;
            
            document.getElementById('treatmentChoice').style.display = 'none';
            showZoneSelection(request, treatmentType);
            document.getElementById('confirmZoneBtn').textContent = '‚úÖ Confirmer l\'attribution';
            
            onZoneSelected();
            vibrate([50]); // Feedback de s√©lection
        }

        function showZoneSelection(request, treatmentType) {
            document.getElementById('zoneChoice').style.display = 'block';
            
            const statusInfo = document.getElementById('statusInfo');
            if (treatmentType === 'available-separated') {
                statusInfo.innerHTML = `
                    <div class="separated-info">
                        ‚ö†Ô∏è <strong>Attribution avec places s√©par√©es</strong><br>
                        <small>Les personnes ne seront pas assises c√¥te √† c√¥te</small>
                    </div>
                `;
            } else {
                statusInfo.innerHTML = `
                    <div class="normal-info">
                        ‚úÖ <strong>Attribution normale</strong><br>
                        <small>Les personnes seront assises ensemble</small>
                    </div>
                `;
            }
            
            const zoneSelection = document.getElementById('zoneSelection');
            zoneSelection.innerHTML = '';
            
            Object.entries(zones).forEach(([zoneId, zone]) => {
                const available = zone.current >= request.placesNeeded;
                const div = document.createElement('div');
                div.className = `zone-option ${available ? 'available' : 'unavailable'}`;
                div.innerHTML = `
                    <input type="radio" name="selectedZone" value="${zoneId}" 
                           id="zone-${zoneId}" ${available ? '' : 'disabled'}
                           onchange="onZoneSelected()">
                    <label for="zone-${zoneId}">
                        <strong>${zone.name}</strong>
                        <span class="zone-capacity">${zone.current}/${zone.max} places</span>
                        ${available ? '‚úÖ' : '‚ùå'}
                    </label>
                `;
                zoneSelection.appendChild(div);
            });
            
            onZoneSelected();
        }

        function closeZoneModal() {
            // V√©rifier si on est en train d'abandonner une demande en cours de traitement
            if (currentRequestForZone && currentRequestForZone.action === 'process-request') {
                const request = currentRequests.get(currentRequestForZone.requestId);
                if (request && request.status === 'in-progress') {
                    // Demander confirmation avant d'abandonner
                    if (confirm('Abandonner le traitement de cette demande ?\n\nElle repassera en attente pour permettre √† d\'autres de la traiter.')) {
                        abandonRequest(currentRequestForZone.requestId);
                    } else {
                        // L'utilisateur a annul√© l'abandon, on garde la modale ouverte
                        return;
                    }
                }
            }
            
            document.getElementById('zoneModalOverlay').style.display = 'none';
            currentRequestForZone = null;
            document.getElementById('confirmZoneBtn').disabled = true;
            document.getElementById('backBtn').style.display = 'none';
            vibrate([30]); // Feedback de fermeture
        }

        function onZoneSelected() {
            const handlerName = document.getElementById('handlerName').value.trim();
            const selectedZone = document.querySelector('input[name="selectedZone"]:checked');
            
            if (currentRequestForZone?.action === 'process-request' && !currentRequestForZone.targetStatus) {
                document.getElementById('confirmZoneBtn').disabled = !handlerName;
            } else {
                document.getElementById('confirmZoneBtn').disabled = !(handlerName && selectedZone);
            }
        }

        function confirmZoneAssignment() {
            if (!currentRequestForZone) return;
            
            const handlerName = document.getElementById('handlerName').value.trim();
            if (!handlerName) return;
            
            if (currentRequestForZone.action === 'process-request' && !currentRequestForZone.targetStatus) {
                return;
            } else {
                const selectedZone = document.querySelector('input[name="selectedZone"]:checked')?.value;
                if (!selectedZone) return;
                
                console.log('üéØ Attribution finale:', currentRequestForZone.requestId, selectedZone, handlerName);
                
                socket.emit('update_request_status', {
                    requestId: currentRequestForZone.requestId,
                    status: currentRequestForZone.targetStatus,
                    assignedZone: selectedZone,
                    handledByName: handlerName
                });
                
                vibrate([100, 50, 100]); // Feedback de confirmation
                closeZoneModal();
            }
        }

        // ===========================================
        // GESTION DE L'INTERFACE
        // ===========================================

        function updateConnectionStatus(connected) {
            // Pas d'affichage de statut dans cette version mobile
        }

        function updateConnectedUsers(count) {
            connectedUsers = count;
        }

        function updateZonesSummary() {
            const totalAvailable = Object.values(zones).reduce((sum, zone) => sum + zone.current, 0);
            document.getElementById('totalAvailable').textContent = totalAvailable;
        }

        function filterRequests() {
            const filter = document.getElementById('statusFilter').value;
            const cards = document.querySelectorAll('.request-card');
            
            cards.forEach(card => {
                const status = card.classList[1];
                card.style.display = (filter === 'all' || status === filter) ? 'block' : 'none';
            });
        }

        // ===========================================
        // INITIALISATION
        // ===========================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Application des demandes initialis√©e (version mobile)');
            
            // Pr√©-remplissage pour les tests
            const randomNames = ['Alice Martin', 'Bob Dupont', 'Claire Bernard', 'David Moreau'];
            document.getElementById('userName').value = 
                randomNames[Math.floor(Math.random() * randomNames.length)];
            
            const handlerNameInput = document.getElementById('handlerName');
            if (handlerNameInput) {
                handlerNameInput.addEventListener('input', updateConfirmButtonState);
            }

            // Ajout de listeners pour le feedback tactile
            document.querySelectorAll('.btn, .zone, .request-card').forEach(element => {
                element.addEventListener('touchstart', () => {
                    vibrate([30]);
                }, { passive: true });
            });
        });

        // Gestion des erreurs globales
        window.addEventListener('error', (event) => {
            console.error('‚ùå Erreur JavaScript:', event.error);
            vibrate([200, 100, 200]); // Vibration d'erreur
        });

        // Emp√™cher le zoom sur double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>